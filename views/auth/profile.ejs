<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <meta name="description" content="Your SEO Generator profile and usage history">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/auth.css">
    <link rel="icon" type="image/png" href="/favicon.png">
</head>
<body>
    <div class="container">
        <!-- Include Shared Header -->
        <% var subtitle = 'Your Profile & Usage History'; %>
        <%- include('../partials/header') %>

        <main class="main">
            <!-- User Info Section -->
            <section class="profile-section">
                <h2 class="section-title">üë§ Account Information</h2>
                <div class="profile-card">
                    <div class="profile-info">
                        <div class="info-item">
                            <span class="info-label">Username:</span>
                            <span class="info-value"><%= user.username %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email:</span>
                            <span class="info-value"><%= user.email %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Member since:</span>
                            <span class="info-value"><%= new Date(user.created_at).toLocaleDateString() %></span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Credits Section -->
            <section class="credits-section">
                <h2 class="section-title">üíé Credits</h2>
                <div class="credits-card">
                    <div class="credits-display">
                        <div class="credits-amount">
                            <span class="credits-number"><%= user.credits %></span>
                            <span class="credits-label">Available Credits</span>
                        </div>
                        <div class="credits-info">
                            <p>Each AI enhancement costs 1 credit</p>
                            <p>You can use these credits for:</p>
                            <ul>
                                <li>‚ú® AI-powered description enhancement</li>
                                <li>üéØ SEO optimization suggestions</li>
                                <li>üìù Content improvement recommendations</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Add Credits Form (for demo purposes) -->
                    <div class="add-credits-form">
                        <h3>Add Demo Credits</h3>
                        <div class="form-row">
                            <input 
                                type="number" 
                                id="creditsToAdd" 
                                class="form-input" 
                                placeholder="Number of credits"
                                min="1"
                                max="100"
                                value="5"
                            >
                            <button onclick="addCredits()" class="add-credits-button">
                                <span class="button-icon">‚ûï</span>
                                Add Credits
                            </button>
                        </div>
                        <div id="addCreditsStatus" class="status-message"></div>
                    </div>
                </div>
            </section>

            <!-- Usage History Section -->
            <section class="usage-section">
                <h2 class="section-title">üìä Usage History</h2>
                <div class="usage-card">
                    <% if (usageHistory && usageHistory.length > 0) { %>
                        <div class="usage-table">
                            <div class="usage-header">
                                <div class="usage-cell">Action</div>
                                <div class="usage-cell">Credits Used</div>
                                <div class="usage-cell">Description</div>
                                <div class="usage-cell">Date</div>
                            </div>
                            <% usageHistory.forEach(usage => { %>
                                <div class="usage-row">
                                    <div class="usage-cell">
                                        <span class="usage-action"><%= usage.action %></span>
                                    </div>
                                    <div class="usage-cell">
                                        <span class="credits-used">-<%= usage.credits_used %></span>
                                    </div>
                                    <div class="usage-cell">
                                        <span class="usage-description"><%= usage.description %></span>
                                    </div>
                                    <div class="usage-cell">
                                        <span class="usage-date"><%= new Date(usage.created_at).toLocaleDateString() %></span>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    <% } else { %>
                        <div class="no-usage">
                            <p>No usage history yet. Start generating SEO assets to see your activity here!</p>
                        </div>
                    <% } %>
                </div>
            </section>

            <!-- Navigation Section -->
            <section class="navigation-section">
                <div class="nav-buttons">
                    <a href="/" class="nav-button">
                        <span class="button-icon">üè†</span>
                        Back to Generator
                    </a>
                    <a href="/auth/logout" class="nav-button secondary">
                        <span class="button-icon">üö™</span>
                        Logout
                    </a>
                </div>
            </section>
        </main>
    </div>

    <!-- Include Shared Footer -->
    <%- include('../partials/footer') %>

    <script>
        async function addCredits() {
            const creditsInput = document.getElementById('creditsToAdd');
            const statusDiv = document.getElementById('addCreditsStatus');
            const button = document.querySelector('.add-credits-button');
            
            const credits = parseInt(creditsInput.value);
            if (!credits || credits < 1 || credits > 100) {
                statusDiv.innerHTML = '<div class="status-message error">Please enter a valid number between 1 and 100</div>';
                return;
            }

            button.disabled = true;
            button.innerHTML = '<span class="loading-spinner"></span> Adding...';
            statusDiv.innerHTML = '<div class="status-message loading">Adding credits...</div>';

            try {
                const response = await fetch('/auth/add-credits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ credits })
                });

                const result = await response.json();

                if (result.success) {
                    statusDiv.innerHTML = '<div class="status-message success">Credits added successfully! Refreshing page...</div>';
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    statusDiv.innerHTML = `<div class="status-message error">${result.message || 'Failed to add credits'}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="status-message error">An error occurred. Please try again.</div>';
            } finally {
                button.disabled = false;
                button.innerHTML = '<span class="button-icon">‚ûï</span> Add Credits';
            }
        }
    </script>
</body>
</html>
